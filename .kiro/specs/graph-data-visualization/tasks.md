# Graph Data Visualization - Tasks

## Task 1: 创建虚拟数据生成器

**目标**: 实现符合语义分层模型的虚拟图数据生成器

**子任务**:
- [ ] 1.1 创建 `services/mockGraphData.ts` 文件
- [ ] 1.2 实现 `GraphNode` 和 `GraphEdge` 类型定义
- [ ] 1.3 实现 `generateSimpleBuilding()` 场景（3层，每层3个空间）
- [ ] 1.4 实现 `generateMEPSystem()` 场景（管线穿越关系）
- [ ] 1.5 实现节点生成逻辑（Space, MEPElement, MEPSystem, Storey）
- [ ] 1.6 实现关系生成逻辑（ADJACENT_TO, CROSSES, BELONGS_TO_SYSTEM, ON_LEVEL）
- [ ] 1.7 添加数据验证（ID 唯一性、边的有效性）
- [ ] 1.8 编写单元测试

**验收标准**:
- 生成的数据包含所有核心节点类型
- 生成的数据包含所有核心关系类型
- 数据结构与 Neo4j 查询结果一致
- 通过所有单元测试

**预计时间**: 3-4 小时

---

## Task 2: 扩展 GraphViewer 组件

**目标**: 增强 GraphViewer 支持虚拟数据渲染和交互

**子任务**:
- [ ] 2.1 更新 `GraphViewer.tsx` 接受 `GraphData` 类型
- [ ] 2.2 实现节点样式配置（按类型区分颜色和形状）
- [ ] 2.3 实现边样式配置（按关系类型区分样式）
- [ ] 2.4 实现节点点击事件处理
- [ ] 2.5 实现边点击事件处理
- [ ] 2.6 实现节点高亮状态
- [ ] 2.7 实现布局切换功能（hierarchy, force, concentric）
- [ ] 2.8 添加缩放和平移控制
- [ ] 2.9 添加节点标签显示

**验收标准**:
- 不同类型节点有明显视觉区分
- 不同类型边有明显样式区分
- 点击节点触发回调事件
- 高亮状态清晰可见
- 布局切换流畅

**预计时间**: 4-5 小时

---

## Task 3: 创建图数据同步 Context

**目标**: 实现三向数据联动的状态管理

**子任务**:
- [ ] 3.1 创建 `contexts/GraphDataSyncContext.tsx`
- [ ] 3.2 定义 Context 接口和状态
- [ ] 3.3 实现 `syncFromGraph()` 方法（图谱 → 模型）
- [ ] 3.4 实现 `syncFromModel()` 方法（模型 → 图谱）
- [ ] 3.5 实现 `syncFromChat()` 方法（对话 → 图谱 + 模型）
- [ ] 3.6 实现 `loadScenario()` 方法（加载虚拟数据场景）
- [ ] 3.7 实现 `expandNeighbors()` 方法（展开邻居节点）
- [ ] 3.8 添加状态持久化（可选）

**验收标准**:
- Context 提供完整的同步接口
- 状态更新触发组件重渲染
- 同步逻辑正确（ID 映射）
- 性能良好（< 200ms）

**预计时间**: 3-4 小时

---

## Task 4: 集成到三分屏布局

**目标**: 将图数据可视化集成到现有布局中

**子任务**:
- [ ] 4.1 在 `App.tsx` 中引入 `GraphDataSyncContext`
- [ ] 4.2 更新 `GraphViewer` 使用 Context 数据
- [ ] 4.3 更新 `SpeckleViewer` 响应 Context 状态
- [ ] 4.4 更新 `ControlPanel` 响应 Context 状态
- [ ] 4.5 实现图谱节点点击 → 模型高亮
- [ ] 4.6 实现模型选择 → 图谱高亮
- [ ] 4.7 实现对话查询 → 双向高亮
- [ ] 4.8 添加场景切换 UI（下拉菜单）

**验收标准**:
- 三个面板正确显示数据
- 点击图谱节点触发模型高亮
- 选择模型元素触发图谱高亮
- 对话查询同步更新两个视图
- 可以切换不同虚拟数据场景

**预计时间**: 4-5 小时

---

## Task 5: 实现空间关系可视化

**目标**: 展示空间之间的邻接和连通关系

**子任务**:
- [ ] 5.1 在虚拟数据中生成空间节点（房间、走廊、机房）
- [ ] 5.2 生成 ADJACENT_TO 关系（空间邻接）
- [ ] 5.3 生成 ON_LEVEL 关系（空间-楼层）
- [ ] 5.4 生成 CONNECTS_TO 关系（可通行连接）
- [ ] 5.5 实现层次布局（按楼层分组）
- [ ] 5.6 添加空间节点样式（蓝色圆形）
- [ ] 5.7 添加楼层节点样式（灰色菱形）
- [ ] 5.8 测试空间关系查询

**验收标准**:
- 图谱清晰展示空间层级
- 邻接关系用实线连接
- 楼层节点作为分组根节点
- 可以筛选显示特定楼层

**预计时间**: 2-3 小时

---

## Task 6: 实现管线穿越关系可视化

**目标**: 展示 MEP 构件穿越空间的关系

**子任务**:
- [ ] 6.1 在虚拟数据中生成 MEP 构件节点（管道、风管、桥架）
- [ ] 6.2 生成 CROSSES 关系（构件穿越空间）
- [ ] 6.3 添加 MEP 构件节点样式（绿色矩形）
- [ ] 6.4 添加 CROSSES 边样式（红色虚线）
- [ ] 6.5 实现构件类型筛选
- [ ] 6.6 实现"显示穿越路径"功能
- [ ] 6.7 测试管线穿越查询

**验收标准**:
- 图谱清晰展示管线穿越关系
- CROSSES 边使用虚线区分
- 可以筛选显示特定类型管线
- 点击管线高亮穿越的空间

**预计时间**: 2-3 小时

---

## Task 7: 实现系统连接关系可视化

**目标**: 展示构件属于哪个系统

**子任务**:
- [ ] 7.1 在虚拟数据中生成系统节点（HVAC、电气、消防）
- [ ] 7.2 生成 BELONGS_TO_SYSTEM 关系
- [ ] 7.3 添加系统节点样式（橙色六边形）
- [ ] 7.4 添加 BELONGS_TO_SYSTEM 边样式（带箭头）
- [ ] 7.5 实现系统筛选功能
- [ ] 7.6 实现"显示系统构件"功能
- [ ] 7.7 测试系统关系查询

**验收标准**:
- 图谱清晰展示系统归属关系
- 系统节点使用六边形区分
- 可以筛选显示特定系统
- 点击系统高亮所有构件

**预计时间**: 2-3 小时

---

## Task 8: 实现布局算法切换

**目标**: 支持多种布局算法并可手动切换

**子任务**:
- [ ] 8.1 实现层次布局（Breadthfirst）
- [ ] 8.2 实现力导向布局（COSE）
- [ ] 8.3 实现同心圆布局（Concentric）
- [ ] 8.4 实现网格布局（Grid）
- [ ] 8.5 添加布局切换 UI（按钮组）
- [ ] 8.6 添加布局动画
- [ ] 8.7 优化布局参数（间距、斥力等）
- [ ] 8.8 测试不同数据规模的布局性能

**验收标准**:
- 支持 4 种布局算法
- 布局切换流畅（< 1s）
- 布局参数合理（节点不重叠）
- 大数据量下性能良好

**预计时间**: 3-4 小时

---

## Task 9: 实现节点详情面板

**目标**: 点击节点时显示详细信息

**子任务**:
- [ ] 9.1 创建 `NodeDetailPanel` 组件
- [ ] 9.2 显示节点基本信息（ID、类型、标签）
- [ ] 9.3 显示节点属性（levelCode, tags, category）
- [ ] 9.4 显示节点关系列表（邻居节点）
- [ ] 9.5 添加"展开邻居"按钮
- [ ] 9.6 添加"在模型中定位"按钮
- [ ] 9.7 集成到 ControlPanel
- [ ] 9.8 添加关闭按钮

**验收标准**:
- 点击节点显示详情面板
- 详情信息完整准确
- 可以展开查看邻居节点
- 可以跳转到 3D 模型

**预计时间**: 2-3 小时

---

## Task 10: 性能优化和测试

**目标**: 优化性能并完成测试

**子任务**:
- [ ] 10.1 实现节点懒加载（初始只显示一层）
- [ ] 10.2 实现视口裁剪（只渲染可见节点）
- [ ] 10.3 优化事件处理（防抖和节流）
- [ ] 10.4 优化状态管理（useMemo, useCallback）
- [ ] 10.5 编写集成测试（三向联动）
- [ ] 10.6 编写性能测试（100/500 节点）
- [ ] 10.7 测试不同浏览器兼容性
- [ ] 10.8 编写使用文档

**验收标准**:
- 100 节点渲染 < 500ms
- 500 节点渲染 < 2s
- 同步响应 < 200ms
- 通过所有测试
- 文档完整

**预计时间**: 4-5 小时

---

## 总预计时间

**总计**: 29-38 小时（约 4-5 个工作日）

## 任务依赖关系

```
Task 1 (虚拟数据生成器)
  ↓
Task 2 (GraphViewer 增强) ← Task 3 (同步 Context)
  ↓                              ↓
Task 4 (集成到布局) ←──────────────┘
  ↓
Task 5 (空间关系) + Task 6 (管线穿越) + Task 7 (系统连接)
  ↓
Task 8 (布局切换) + Task 9 (详情面板)
  ↓
Task 10 (性能优化和测试)
```

## 建议执行顺序

1. **第一天**: Task 1 + Task 2（基础数据和渲染）
2. **第二天**: Task 3 + Task 4（同步机制和集成）
3. **第三天**: Task 5 + Task 6 + Task 7（三种关系可视化）
4. **第四天**: Task 8 + Task 9（布局和交互优化）
5. **第五天**: Task 10（性能优化和测试）

## 里程碑

- **M1 (Day 2)**: 基础图谱可视化完成，可以显示虚拟数据
- **M2 (Day 3)**: 三向联动完成，可以点击交互
- **M3 (Day 4)**: 三种核心关系全部展示
- **M4 (Day 5)**: 性能优化完成，可以交付使用

## 风险和缓解

### 风险 1: Cytoscape.js 性能问题
- **缓解**: 实现懒加载和视口裁剪
- **备选**: 考虑使用 D3.js 或 vis.js

### 风险 2: 三向同步复杂度高
- **缓解**: 使用 Context 集中管理状态
- **备选**: 使用 Redux 或 Zustand

### 风险 3: 虚拟数据不够真实
- **缓解**: 参考真实 BIM 模型结构
- **备选**: 提前准备真实数据样本

## 下一步

完成此 spec 后，可以继续：
1. **neo4j-integration**: 接入真实 Neo4j 数据库
2. **llm-cypher-generation**: 实现自然语言 → Cypher 查询
3. **speckle-integration**: 从 Speckle 模型提取语义
