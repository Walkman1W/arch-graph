# Graph Data Visualization - Requirements

## 概述

实现基于虚拟数据的图谱可视化系统，展示 BIM 模型的空间语义关系，并实现与 3D 模型查看器和对话面板的三向数据联动。

## 用户故事

### US-1: 图谱数据可视化
**作为** 建筑师/设施管理员  
**我想要** 在图谱查看器中看到建筑空间、构件、系统之间的关系  
**以便于** 理解建筑的空间拓扑和机电系统连接

**验收标准:**
- AC-1.1: 图谱显示不同类型的节点（空间、构件、系统、楼层）
- AC-1.2: 节点使用不同颜色和形状区分类型
- AC-1.3: 边使用不同样式区分关系类型（邻接、穿越、归属）
- AC-1.4: 节点显示清晰的标签（名称）
- AC-1.5: 支持缩放、平移、拖拽节点

### US-2: 空间关系展示
**作为** 用户  
**我想要** 看到空间之间的邻接和连通关系  
**以便于** 理解建筑的空间布局和可达性

**验收标准:**
- AC-2.1: 显示空间节点（房间、走廊、机房等）
- AC-2.2: 显示 ADJACENT_TO 关系（空间邻接）
- AC-2.3: 显示 ON_LEVEL 关系（空间所属楼层）
- AC-2.4: 显示 CONNECTS_TO 关系（可通行连接）
- AC-2.5: 空间节点按楼层分组显示

### US-3: 管线穿越关系展示
**作为** 机电工程师  
**我想要** 看到管线穿越哪些空间  
**以便于** 分析管线路径和空间冲突

**验收标准:**
- AC-3.1: 显示 MEP 构件节点（管道、风管、桥架）
- AC-3.2: 显示 CROSSES 关系（构件穿越空间）
- AC-3.3: 穿越关系使用虚线或特殊颜色标识
- AC-3.4: 可以筛选显示特定类型的管线

### US-4: 系统连接关系展示
**作为** 机电工程师  
**我想要** 看到构件属于哪个系统  
**以便于** 理解系统组成和设备归属

**验收标准:**
- AC-4.1: 显示系统节点（HVAC、电气、消防等）
- AC-4.2: 显示 BELONGS_TO_SYSTEM 关系
- AC-4.3: 同一系统的构件可以高亮显示
- AC-4.4: 系统节点使用特殊样式（如六边形）

### US-5: 三向数据联动 - 图谱到模型
**作为** 用户  
**我想要** 点击图谱节点时在 3D 模型中高亮对应构件  
**以便于** 快速定位和查看构件的空间位置

**验收标准:**
- AC-5.1: 点击图谱节点触发 3D 模型高亮
- AC-5.2: 高亮效果清晰可见（颜色变化或边框）
- AC-5.3: 支持多选节点同时高亮
- AC-5.4: 高亮状态在两个视图中保持同步

### US-6: 三向数据联动 - 模型到图谱
**作为** 用户  
**我想要** 在 3D 模型中选择构件时在图谱中高亮对应节点  
**以便于** 查看该构件的关系网络

**验收标准:**
- AC-6.1: 3D 模型选择触发图谱节点高亮
- AC-6.2: 自动展开显示相关节点（邻居节点）
- AC-6.3: 图谱自动居中到选中节点
- AC-6.4: 显示选中节点的直接关系

### US-7: 三向数据联动 - 对话框交互
**作为** 用户  
**我想要** 在对话框中查询时同步更新图谱和模型  
**以便于** 通过自然语言探索建筑数据

**验收标准:**
- AC-7.1: 对话框查询结果在图谱中高亮显示
- AC-7.2: 查询结果在 3D 模型中高亮显示
- AC-7.3: 对话框显示查询结果摘要
- AC-7.4: 支持"显示相关节点"等交互命令

### US-8: 虚拟数据生成
**作为** 开发者  
**我想要** 使用虚拟数据快速验证功能  
**以便于** 在真实数据接入前完成界面开发

**验收标准:**
- AC-8.1: 生成符合语义分层模型的虚拟节点
- AC-8.2: 生成符合关系类型定义的虚拟边
- AC-8.3: 虚拟数据包含所有核心关系类型
- AC-8.4: 数据结构与 Neo4j 查询结果一致
- AC-8.5: 支持切换不同的虚拟数据场景

### US-9: 图谱布局优化
**作为** 用户  
**我想要** 图谱自动使用合适的布局算法  
**以便于** 清晰地看到节点关系

**验收标准:**
- AC-9.1: 支持层次布局（按楼层分层）
- AC-9.2: 支持力导向布局（自动分散节点）
- AC-9.3: 支持同心圆布局（中心节点辐射）
- AC-9.4: 可以手动切换布局算法
- AC-9.5: 布局动画流畅（< 1s）

### US-10: 节点和边样式定制
**作为** 用户  
**我想要** 不同类型的节点和边有明显的视觉区分  
**以便于** 快速识别元素类型

**验收标准:**
- AC-10.1: 空间节点使用圆形，颜色为蓝色系
- AC-10.2: 构件节点使用矩形，颜色为绿色系
- AC-10.3: 系统节点使用六边形，颜色为橙色系
- AC-10.4: 楼层节点使用菱形，颜色为灰色系
- AC-10.5: ADJACENT_TO 边使用实线
- AC-10.6: CROSSES 边使用虚线
- AC-10.7: BELONGS_TO_SYSTEM 边使用箭头
- AC-10.8: 选中状态使用高亮边框和阴影

## 非功能需求

### NFR-1: 性能
- 图谱渲染时间 < 500ms（100 个节点）
- 节点选择响应时间 < 100ms
- 三向同步延迟 < 200ms
- 布局切换动画流畅（60fps）

### NFR-2: 可扩展性
- 支持 500+ 节点的图谱显示
- 支持动态加载更多节点（懒加载）
- 数据结构与 Neo4j 查询结果兼容
- 易于切换到真实数据源

### NFR-3: 可用性
- 图谱操作直观（拖拽、缩放、点击）
- 节点标签清晰可读
- 颜色对比度符合 WCAG 标准
- 支持键盘快捷键（如 Ctrl+滚轮缩放）

### NFR-4: 可维护性
- 虚拟数据生成器独立模块
- 数据同步服务解耦
- 样式配置集中管理
- 完整的 TypeScript 类型定义

## 数据模型

### 节点类型（基于 arch-grpha.md 语义分层）

```typescript
type NodeType = 
  | 'Space'       // 空间层：房间、走廊、机房
  | 'MEPElement'  // 构件层：管道、风管、桥架
  | 'MEPSystem'   // 结构层：HVAC、电气、消防系统
  | 'Storey'      // 结构层：楼层
  | 'RouteNode';  // 拓扑层：路径节点

interface GraphNode {
  id: string;
  type: NodeType;
  label: string;
  properties: {
    globalId?: string;      // BIM 全局 ID
    levelCode?: string;     // 楼层编码
    category?: string;      // Revit Category
    tags?: string[];        // 语义标签
    bbox?: BoundingBox;     // 包围盒
    systemCode?: string;    // 系统编码
  };
}
```

### 关系类型（基于 arch-grpha.md 关系映射）

```typescript
type EdgeType =
  | 'ON_LEVEL'            // 空间-楼层
  | 'ADJACENT_TO'         // 空间邻接
  | 'CONNECTS_TO'         // 可通行连接
  | 'CROSSES'             // 构件穿越空间
  | 'BELONGS_TO_SYSTEM'   // 构件属于系统
  | 'SERVES'              // 构件服务空间
  | 'IN_BUILDING'         // 空间属于建筑
  | 'IN_ZONE';            // 空间属于区域

interface GraphEdge {
  id: string;
  source: string;
  target: string;
  type: EdgeType;
  properties?: {
    weight?: number;      // 路径权重
    via?: string;         // 通过门洞
    distance?: number;    // 距离
  };
}
```

## 技术约束

- 使用 Cytoscape.js 作为图谱可视化库
- 虚拟数据生成器使用 TypeScript
- 数据同步通过 React Context 或自定义 hooks
- 样式使用 Cytoscape.js 样式系统
- 与现有三分屏布局集成

## 依赖关系

- 依赖 `three-pane-layout` spec（布局容器）
- 依赖现有 `GraphViewer` 组件
- 依赖现有 `SpeckleViewer` 组件
- 依赖现有 `ControlPanel` 组件

## 优先级

1. **P0 (必须)**: US-1, US-2, US-3, US-4, US-8（基础可视化和虚拟数据）
2. **P1 (重要)**: US-5, US-6, US-7（三向联动）
3. **P2 (可选)**: US-9, US-10（布局和样式优化）

## 成功指标

- 图谱能够清晰展示三种核心关系
- 三向联动响应时间 < 200ms
- 虚拟数据覆盖所有关系类型
- 用户可以通过图谱快速理解建筑结构
